<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hadith Text Comparison Tool</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Sidebar Toggle Button -->
        <button id="sidebar-toggle" class="sidebar-toggle-btn" title="Settings">
            <i class="material-icons">settings</i>
        </button>

        <h1>Hadith Text Comparison Tool</h1>
        
        <!-- Regenerate All Button -->
        <div class="controls">
        <div class="pagination-info">
            {% if total_rows > 0 %}
                Showing {{ (current_page - 1) * rows_per_page + 1 }} to 
                {{ [current_page * rows_per_page, total_rows] | min }} of {{ total_rows }} rows
            {% endif %}
        </div>

        <div class="regenerate-controls">
            <select id="regenerate-color-select" class="regenerate-color-select">
                <option value="any">Any Color</option>
                <option value="none">No Color</option>
                <option value="green">Green</option>
                <option value="yellow">Yellow</option>
                <option value="red">Red</option>
            </select>
            <button id="regenerate-all-btn" class="regenerate-all-btn" title="Regenerate all cells">
                <i class="material-icons">offline_bolt</i> Regenerate All
            </button>
        </div>
        </div>

        {% if data %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Column A</th>
                        <th>Column B</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data %}
                        <tr>
                            <td>{{ item.id }}</td>
                            <td class="{{ item.status }} {% if item.col_a_approved %}{% if item.col_a_type == 'green' %}approved{% elif item.col_a_type == 'yellow' %}yellow-approved{% elif item.col_a_type == 'red' %}red-approved{% endif %}{% endif %}">
                                <div class="cell-container">
                                    <div class="cell-content" data-row="{{ item.row_idx }}">
                                        {% if item.status == 'different' %}{{ item.highlighted_a | safe }}{% else %}{{ item.col_a | replace('\n', '<br>') | safe }}{% endif %}
                                    </div>
                                    <div class="action-buttons-container">
                                        <div class="action-buttons">
                                            <form action="/approve" method="post">
                                                <input type="hidden" name="row_idx" value="{{ item.row_idx }}">
                                                <input type="hidden" name="column" value="a">
                                                <input type="hidden" name="page" value="{{ current_page }}">
                                                <input type="hidden" name="rows_per_page" value="{{ rows_per_page }}">
                                                <input type="hidden" name="approval_type" value="green">
                                                <button type="submit" class="tick-btn" title="Approve this cell">
                                                    <i class="material-icons">check_circle</i>
                                                </button>
                                            </form>
                                            <form action="/reset_cell" method="post">
                                                <input type="hidden" name="row_idx" value="{{ item.row_idx }}">
                                                <input type="hidden" name="column" value="a">
                                                <input type="hidden" name="page" value="{{ current_page }}">
                                                <input type="hidden" name="rows_per_page" value="{{ rows_per_page }}">
                                                <button type="submit" class="reset-btn" title="Reset approval">
                                                    <i class="material-icons">cancel</i>
                                                </button>
                                            </form>
                                            <button class="show-arabic-btn" data-row="{{ item.row_idx }}" title="Show Arabic Text">
                                                <i class="material-icons">translate</i>
                                            </button>
                                            <button class="show-bangla-btn" data-row="{{ item.row_idx }}" title="Show Bangla Text">
                                                <i class="material-icons">spellcheck</i>
                                            </button>
                                            <button class="generate-bangla-btn" data-row="{{ item.row_idx }}" title="Generate New Bangla Translation">
                                                <i class="material-icons">offline_bolt</i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="{{ item.status }} {% if item.col_b_approved %}{% if item.col_b_type == 'green' %}approved{% elif item.col_b_type == 'yellow' %}yellow-approved{% elif item.col_b_type == 'red' %}red-approved{% endif %}{% endif %}">
                                <div class="cell-container">
                                    <div class="cell-content" data-editable data-row="{{ item.row_idx }}">
                                        {% if item.status == 'different' %}{{ item.highlighted_b | safe }}{% else %}{{ item.col_b | replace('\n', '<br>') | safe }}{% endif %}
                                    </div>
                                    <textarea class="editable" data-row="{{ item.row_idx }}" data-page="{{ current_page }}" data-rows="{{ rows_per_page }}">{{ item.col_b }}</textarea>
                                    <div class="action-buttons-container">
                                        <div style="font-size: 0.9em; opacity: 0.8;margin-top: 4px;">{{ "%.2f"|format(item.ratio) }}</div>
                                        <div class="action-buttons">
                                            <button class="save-btn" data-row="{{ item.row_idx }}" data-page="{{ current_page }}" data-rows="{{ rows_per_page }}" style="display:none;" title="Save changes">
                                                <i class="material-icons">save</i>
                                            </button>
                                            <button class="edit-btn" data-row="{{ item.row_idx }}" data-text="{{ item.col_b|replace('\n', ' ')|e }}" data-page="{{ current_page }}" data-rows="{{ rows_per_page }}" title="Edit this cell">
                                                <i class="material-icons">edit</i>
                                            </button>
                                            <form action="/approve" method="post">
                                                <input type="hidden" name="row_idx" value="{{ item.row_idx }}">
                                                <input type="hidden" name="column" value="b">
                                                <input type="hidden" name="page" value="{{ current_page }}">
                                                <input type="hidden" name="rows_per_page" value="{{ rows_per_page }}">
                                                <input type="hidden" name="approval_type" value="green">
                                                <button type="submit" class="tick-btn" title="Green approve">
                                                    <i class="material-icons">check_circle</i>
                                                </button>
                                            </form>
                                            <form action="/approve" method="post">
                                                <input type="hidden" name="row_idx" value="{{ item.row_idx }}">
                                                <input type="hidden" name="column" value="b">
                                                <input type="hidden" name="page" value="{{ current_page }}">
                                                <input type="hidden" name="rows_per_page" value="{{ rows_per_page }}">
                                                <input type="hidden" name="approval_type" value="yellow">
                                                <button type="submit" class="yellow-tick-btn" title="Yellow approve">
                                                    <i class="material-icons">check_circle</i>
                                                </button>
                                            </form>
                                            <form action="/approve" method="post">
                                                <input type="hidden" name="row_idx" value="{{ item.row_idx }}">
                                                <input type="hidden" name="column" value="b">
                                                <input type="hidden" name="page" value="{{ current_page }}">
                                                <input type="hidden" name="rows_per_page" value="{{ rows_per_page }}">
                                                <input type="hidden" name="approval_type" value="red">
                                                <button type="submit" class="red-tick-btn" title="Red approve">
                                                    <i class="material-icons">check_circle</i>
                                                </button>
                                            </form>
                                            <form action="/reset_cell" method="post">
                                                <input type="hidden" name="row_idx" value="{{ item.row_idx }}">
                                                <input type="hidden" name="column" value="b">
                                                <input type="hidden" name="page" value="{{ current_page }}">
                                                <input type="hidden" name="rows_per_page" value="{{ rows_per_page }}">
                                                <button type="submit" class="reset-btn" title="Reset approval">
                                                    <i class="material-icons">cancel</i>
                                                </button>
                                            </form>
                                            <button class="generate-btn" data-row="{{ item.row_idx }}" data-page="{{ current_page }}" data-rows="{{ rows_per_page }}" title="Regenerate with API">
                                                <i class="material-icons">offline_bolt</i>
                                            </button>
                                            <button class="regenerate-btn-1" data-row="{{ item.row_idx }}" data-page="{{ current_page }}" data-rows="{{ rows_per_page }}" title="Regenerate 1">
                                                <i class="material-icons">looks_one</i>
                                            </button>
                                            <button class="regenerate-btn-2" data-row="{{ item.row_idx }}" data-page="{{ current_page }}" data-rows="{{ rows_per_page }}" title="Regenerate 2">
                                                <i class="material-icons">looks_two</i>
                                            </button>
                                            <button class="custom-prompt-btn" data-row="{{ item.row_idx }}" data-page="{{ current_page }}" data-rows="{{ rows_per_page }}" title="Custom Prompt">
                                                <i class="material-icons">edit_note</i>
                                            </button>
                                            <button class="comment-btn" data-row="{{ item.row_idx }}" data-page="{{ current_page }}" data-rows="{{ rows_per_page }}" title="Add Comment">
                                                <i class="material-icons">comment</i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if total_pages > 1 %}
                <div class="pagination">
                    {% if current_page > 1 %}
                        {% set page_1_params = query_params.copy() %}
                        {% set _ = page_1_params.update({'page': 1}) %}
                        <a href="?{{ urlencode(page_1_params) }}">« First</a>
                        {% set prev_params = query_params.copy() %}
                        {% set _ = prev_params.update({'page': current_page - 1}) %}
                        <a href="?{{ urlencode(prev_params) }}">Previous</a>
                    {% endif %}
                    {% set start_page = [1, current_page - 2] | max %}
                    {% set end_page = [total_pages + 1, current_page + 3] | min %}
                    {% for p in range(start_page, end_page) %}
                        {% if p == current_page %}
                            <span class="active">{{ p }}</span>
                        {% else %}
                            {% set page_p_params = query_params.copy() %}
                            {% set _ = page_p_params.update({'page': p}) %}
                            <a href="?{{ urlencode(page_p_params) }}">{{ p }}</a>
                        {% endif %}
                    {% endfor %}
                    {% if current_page < total_pages %}
                        {% set next_params = query_params.copy() %}
                        {% set _ = next_params.update({'page': current_page + 1}) %}
                        <a href="?{{ urlencode(next_params) }}">Next</a>
                        {% set last_params = query_params.copy() %}
                        {% set _ = last_params.update({'page': total_pages}) %}
                        <a href="?{{ urlencode(last_params) }}">Last »</a>
                    {% endif %}
                </div>
            {% endif %}
        {% else %}
            <div class="no-data">
                <p>No data available. Please ensure 'input.xlsx' file exists in the application directory with a 'hadith' sheet containing columns 'hadith_details' and 'analysis-3'.</p>
                <p>All approvals are stored as colored cells directly in the Excel file.</p>
            </div>
        {% endif %}
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">Cell approved successfully!</div>

    <!-- Comment Modal -->
    <div id="commentModal" class="comment-modal">
        <div class="comment-modal-content">
            <span class="close-comment">×</span>
            <h3>Add Comment</h3>
            <textarea id="commentText" class="comment-textarea" placeholder="Enter your comment here..."></textarea>
            <input type="hidden" id="commentRowIdx" value="">
            <input type="hidden" id="commentPage" value="">
            <input type="hidden" id="commentRowsPerPage" value="">
            <div class="comment-buttons">
                <button id="commentCancelBtn" class="comment-cancel-btn">Cancel</button>
                <button id="commentSaveBtn" class="comment-save-btn">Save Comment</button>
            </div>
        </div>
    </div>

    <!-- Custom Prompt Modal -->
    <div id="customPromptModal" class="comment-modal">
        <div class="comment-modal-content custom-prompt-content">
            <span class="close-comment">×</span>
            <h3>Custom Prompt</h3>
            <p class="prompt-description">Customize your prompt below. You can use these placeholders:</p>
            <div class="placeholder-list">
                <span class="placeholder-item">{arabic_text}</span>
                <span class="placeholder-item">{col_a_text}</span>
                <span class="placeholder-item">{col_b_text}</span>
            </div>
            <textarea id="customPromptText" class="comment-textarea custom-prompt-textarea" placeholder="Enter your custom prompt here..."></textarea>
            <input type="hidden" id="promptRowIdx" value="">
            <input type="hidden" id="promptPage" value="">
            <input type="hidden" id="promptRowsPerPage" value="">
            <div class="comment-buttons">
                <button id="promptCancelBtn" class="comment-cancel-btn">Cancel</button>
                <button id="promptGenerateBtn" class="comment-save-btn">Generate</button>
            </div>
        </div>
    </div>

    <!-- Floating Save Button -->
    <div id="selectionButton" style="display: none; position: absolute; z-index: 1000;">
        <i class="material-icons">add_circle</i>
        Add Selection
    </div>

    <!-- Sidebar with Combined Filters -->
    <div id="settings-sidebar" class="sidebar">
        <button id="sidebar-close" class="sidebar-close-btn">×</button>
        <h3>Settings</h3>
        <hr>

        <div class="sidebar-section theme-section">
            <span class="section-title">Display Theme</span>
            <div class="theme-switch-wrapper">
                <label class="switch" for="checkbox">
                    <input type="checkbox" id="checkbox" />
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        <hr>
        
        <!-- Data Selection Section -->
        <div class="sidebar-section data-section">
            <!-- Chunk Selector -->
            <div class="setting-item compact">
                <form action="/select_chunk" method="post" id="chunk-form" style="display: flex;justify-content: space-between; align-items: center;">
                    <label for="chunk_path">Chunk:</label>
                    <select name="chunk_path" id="chunk_path" onchange="this.form.submit()" class="compact-select">
                        {% for chunk in available_chunks %}
                            <option value="{{ chunk.filename }}" {% if current_chunk == chunk.filename %}selected{% endif %}>
                                {{ chunk.display_name }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            
            <!-- Rows per page -->
            <div class="setting-item compact" style="margin-top: 10px;">
                <form action="/" method="get" id="rows-form" style="display: flex;justify-content: space-between; align-items: center;">
                    <!-- Preserve all current query parameters except 'rows_per_page' and 'page' -->
                    {% for key, value in request.args.items() if key not in ['rows_per_page', 'page'] %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endfor %}
                    <input type="hidden" name="page" value="1">
                    <label for="rows_per_page">Rows:</label>
                    <select name="rows_per_page" id="rows_per_page" onchange="this.form.submit()" class="compact-select">
                        <option value="10" {% if rows_per_page == 10 %}selected{% endif %}>10</option>
                        <option value="50" {% if rows_per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if rows_per_page == 100 %}selected{% endif %}>100</option>
                    </select>
                </form>
            </div>
        </div>
        <hr>
        
        <!-- Theme Switch -->
        
        <div class="sidebar-section filter-section">
            <form action="/" method="get" id="combined-filter-form">
                <input type="hidden" name="page" value="1">
                <input type="hidden" name="rows_per_page" value="{{ rows_per_page }}">
                <input type="hidden" name="filter_change_enabled" value="on">

                <h4>Sort By Ratio</h4>
                <div class="filter-item">
                    <label for="sort-order" style="margin-right: 80px;">Sort by Ratio:</label>
                    <select name="sort_order" id="sort-order" class="filter-select">
                        <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Asc (Different First)</option>
                        <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Desc (Similar First)</option>
                        <option value="none" {% if sort_order == 'none' %}selected{% endif %}>No Sorting</option>
                    </select>
                </div>

                <h4>Filter By ID</h4>
                <div class="filter-item">
                    <label for="filter-id-input">Show only ID:</label>
                    <input type="text" name="filter_id" id="filter-id-input" value="{{ request.args.get('filter_id', '') }}" placeholder="Enter ID value">
                </div>

                <h4>Filter By Percentage</h4>
                <div class="filter-item">
                    <label for="filter_change_gt_value">Greater Than ></label>
                    <input type="text" step="any" name="filter_change_gt_value" id="filter_change_gt_value" value="{{ filter_change_gt_value }}" placeholder="e.g., 10">
                </div>
                <div class="filter-item">
                    <label for="filter-change-lt-input">Less Than <</label>
                    <input type="text" step="any" name="filter_change_lt_value" id="filter-change-lt-input" value="{{ filter_change_lt_value }}" placeholder="e.g., 5">
                </div>
                <div class="filter-item range-filter" style="flex-wrap: nowrap;">
                    <label for="filter-change-from-input">Between</label>
                    <input type="text" step="any" name="filter_change_from_value" id="filter-change-from-input" value="{{ filter_change_from_value }}" placeholder="From">
                    <span class="range-separator">and</span>
                    <input type="text" step="any" name="filter_change_to_value" id="filter-change-to-input" value="{{ filter_change_to_value }}" placeholder="To">
                </div>

                <h4>Color Filter</h4>
                <div class="filter-item">
                    <label for="filter-color-a" style="margin-right: 80px;">Column A</label>
                    <select name="filter_color_a" id="filter-color-a" class="filter-select">
                        <option value="any" {% if filter_color_a == 'any' %}selected{% endif %}>Any Color</option>
                        <option value="none" {% if filter_color_a == 'none' %}selected{% endif %}>No Color</option>
                        <option value="green" {% if filter_color_a == 'green' %}selected{% endif %}>Green</option>
                        <option value="red" {% if filter_color_a == 'red' %}selected{% endif %}>Red</option>
                        <option value="yellow" {% if filter_color_a == 'yellow' %}selected{% endif %}>Yellow</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="filter-color-b" style="margin-right: 80px;">Column B</label>
                    <select name="filter_color_b" id="filter-color-b" class="filter-select">
                        <option value="any" {% if filter_color_b == 'any' %}selected{% endif %}>Any Color</option>
                        <option value="none" {% if filter_color_b == 'none' %}selected{% endif %}>No Color</option>
                        <option value="green" {% if filter_color_b == 'green' %}selected{% endif %}>Green</option>
                        <option value="red" {% if filter_color_b == 'red' %}selected{% endif %}>Red</option>
                        <option value="yellow" {% if filter_color_b == 'yellow' %}selected{% endif %}>Yellow</option>
                    </select>
                </div>

                <div class="filter-buttons">
                    <button type="submit" class="btn-apply-filter">Apply Filters</button>
                    <button type="button" onclick="clearFilters()" class="clear-filter-btn">Clear All Filters</button>
                </div>
            </form>
        </div>
        <hr>
        <div class="sidebar-section filter-section">
            <h4>Ratio Calculation</h4>
            <div class="recalculate-section">
                <p>Recalculate similarity ratios between columns.</p>
                <button id="recalculate-ratio-btn" class="btn-apply-filter">Recalculate Ratios</button>
            </div>
        </div>
    </div>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

    <script>
        // Function to clear all filters
        function clearFilters() {            
            const form = document.getElementById('combined-filter-form');
            if (form) {
                // Make sure the filter is enabled
                const enableCheckbox = form.querySelector('input[name="filter_change_enabled"]');
                if (enableCheckbox) enableCheckbox.value = 'on';
                
                // Reset percentage filter inputs
                const changeValueInput = form.querySelector('input[name="filter_change_gt_value"]');
                if (changeValueInput) changeValueInput.value = '';
                const changeLtInput = form.querySelector('input[name="filter_change_lt_value"]');
                if (changeLtInput) changeLtInput.value = '';
                const changeFromInput = form.querySelector('input[name="filter_change_from_value"]');
                if (changeFromInput) changeFromInput.value = '';
                const changeToInput = form.querySelector('input[name="filter_change_to_value"]');
                if (changeToInput) changeToInput.value = '';
                
                // Reset ID filter
                const idFilterInput = form.querySelector('input[name="filter_id"]');
                if (idFilterInput) idFilterInput.value = '';
                
                // Reset color filters to 'any'
                const colorASelect = form.querySelector('select[name="filter_color_a"]');
                if (colorASelect) colorASelect.value = 'any';
                const colorBSelect = form.querySelector('select[name="filter_color_b"]');
                if (colorBSelect) colorBSelect.value = 'any';
                
                // Submit the form to apply cleared filters
                form.submit();
            }
        }
    </script>
</body>
</html>
